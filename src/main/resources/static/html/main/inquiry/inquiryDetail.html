<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>문의 상세보기</title>

    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
    <link href="/css/sb-admin-2.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #b2ebf2;
        }

        .custom-card {
            max-width: 800px;
            margin: 40px auto;
            background-color: white;
            border-radius: 0.35rem;
            border: 1px solid #e3e6f0;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            color: #3a3b45;
        }

        .notice-table {
            width: 100%;
            border-top: 2px solid #3a3b45;
        }
        .notice-table tr {
            border-bottom: 1px solid #e3e6f0;
        }
        .notice-table th, .notice-table td {
            padding: 1rem;
            vertical-align: middle;
        }
        .notice-table th {
            width: 100px;
            font-weight: 700;
            color: #5a5c69;
            background-color: #f8f9fc;
            text-align: center;
        }
        .notice-table td {
            line-height: 1.6;
        }
        .notice-table tr:has(td#contents) th {
            vertical-align: top;
            padding-top: 1.1rem;
        }

        #contents {
            min-height: 150px;
            white-space: pre-wrap;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 2rem;
            padding: 0 1rem 1rem;
        }

        .form-button {
            font-weight: 600;
        }

        #commentSection { margin-top: 40px; padding: 0 1rem 1rem; }
        #commentSection h3 { font-size: 1.5rem; margin-bottom: 1rem; border-top: 1px solid #e3e6f0; padding-top: 2rem;}
        #commentInput { font-size: 1rem; padding: 0.75rem; }
        .comment { padding: 1rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; }
        .comment-text { font-size: 1rem; }
        .comment small { color: gray; }
        .comment .btn-danger, .comment .btn-secondary, .comment .btn-primary, .comment .btn-light { margin-top: 10px; margin-right: 5px; }
    </style>

    <script src="/js/jquery-3.6.0.min.js"></script>
    <script>
        function getParameterByName(name) {
            const url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        let sessionUserId = "";
        let isAdmin = false;
        let noticeData = null;

        function loadNoticeInfo() {
            const nSeq = getParameterByName('nSeq');
            if (!nSeq) {
                alert("잘못된 접근입니다.");
                location.href = "/main/inquiry/inquiryList";
                return;
            }

            $.ajax({
                url: '/inquiry/inquiryInfo',
                type: 'GET',
                data: { nSeq: nSeq },
                success: function(response) {
                    if (response.message === 'SUCCESS') {
                        noticeData = response.data.notice;
                        sessionUserId = response.data.sessionUserId || "";
                        isAdmin = window.sessionStorage.getItem("adminYn") === "Y";

                        $('#title').text(noticeData.title);
                        $('#userId').text(noticeData.userId);
                        $('#regDt').text(noticeData.regDt);
                        $('#contents').html(noticeData.contents.replace(/\n/g, '<br/>'));

                        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ 이 부분 수정 ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
                        if (noticeData.imageUrl) {
                            const $imageContainer = $('#imageContainer');
                            const $imageRow = $imageContainer.closest('tr');

                            // 1. '이미지' 라벨(th)을 숨깁니다.
                            $imageRow.find('th').hide();

                            // 2. 이미지 칸(td)이 테이블 전체 너비를 차지하도록 하고, 불필요한 여백을 제거합니다.
                            $imageContainer.attr('colspan', '2').css('padding', '0');

                            // 3. 이미지를 가로 100%로 채워서 보여줍니다.
                            $imageContainer.html(`<img src="${noticeData.imageUrl}" style="width: 100%; height: auto; display: block;" />`);
                        } else {
                            // 이미지가 없으면 이미지 행 전체를 숨깁니다.
                            $('#imageRow').hide();
                        }
                        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

                        if (noticeData.chgDt) {
                            $('#chgDt').text(noticeData.chgDt);
                            $('#chgDtRow').show();
                        }

                        const isMyPost = sessionUserId === noticeData.userId;
                        if (isMyPost) {
                            $('#btnEdit, #btnDelete').show();
                        } else if (isAdmin) {
                            $('#btnEdit').hide();
                            $('#btnDelete').show();
                        } else {
                            $('#btnEdit, #btnDelete').hide();
                        }

                        loadComments();
                    } else {
                        alert("공지사항을 불러오는 데 실패했습니다.");
                    }
                },
                error: function() {
                    alert("에러가 발생했습니다.");
                }
            });
        }

        function loadComments() {
            $.ajax({
                url: '/comment/list',
                type: 'GET',
                data: { nSeq: getParameterByName('nSeq') },
                success: function(res) {
                    if (res.message === 'SUCCESS') {
                        const comments = res.data;
                        const $list = $('#commentList');
                        $list.empty();
                        if (comments.length === 0) {
                            $list.html('<p>등록된 댓글이 없습니다.</p>');
                            return;
                        }
                        comments.reverse();

                        comments.forEach(c => {
                            const isMyComment = sessionUserId === c.userId;
                            let deleteBtnHtml = '';
                            let editBtnHtml = '';

                            if (isMyComment) {
                                deleteBtnHtml = `<button class="btn btn-sm btn-danger delete-comment" data-id="${c.commentId}">삭제</button>`;
                                editBtnHtml = `<button class="btn btn-sm btn-secondary edit-comment" data-id="${c.commentId}">수정</button>`;
                            } else if (isAdmin) {
                                deleteBtnHtml = `<button class="btn btn-sm btn-danger delete-comment" data-id="${c.commentId}">삭제</button>`;
                            }

                            const commentHtml = `
                                <div class="comment" data-id="${c.commentId}">
                                    <div><strong>${c.userId}</strong> <small>(${c.regDt})</small></div>
                                    <div class="comment-text" style="margin-top: 5px;">${c.comment.replace(/\n/g, '<br/>')}</div>
                                    ${deleteBtnHtml}
                                    ${editBtnHtml}
                                </div>
                            `;
                            $list.append(commentHtml);
                        });
                    } else {
                        alert("댓글을 불러오는 데 실패했습니다.");
                    }
                },
                error: function() {
                    alert("댓글을 불러오는 데 실패했습니다.");
                }
            });
        }

        $(document).ready(function() {
            loadNoticeInfo();

            $('#commentInput').on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); $('#btnAddComment').click(); }
            });

            $('#btnEdit').on('click', function() {
                if (noticeData) { location.href = "/main/inquiry/inquiryEditInfo?nSeq=" + noticeData.noticeSeq; }
            });

            $('#btnDelete').on('click', function() {
                if (noticeData && confirm("작성한 글을 삭제하시겠습니까?")) {
                    $.ajax({
                        url: "/inquiry/inquiryDelete",
                        type: "POST",
                        dataType: "json",
                        data: { nSeq: noticeData.noticeSeq },
                        success: function(response) {
                            const msg = response.data?.msg || response.message || "처리 완료";
                            alert(msg);
                            location.href = "/main/inquiry/inquiryList";
                        },
                        error: function() {
                            alert("삭제 중 에러가 발생했습니다.");
                        }
                    });
                }
            });

            $('#btnList').on('click', function() { location.href = "/main/inquiry/inquiryList"; });

            $('#btnAddComment').on('click', function() {
                const content = $('#commentInput').val().trim();
                if (!content) { alert("댓글을 입력하세요."); return; }
                $.ajax({
                    url: '/comment/add', type: 'POST', contentType: 'application/json',
                    data: JSON.stringify({ noticeSeq: getParameterByName('nSeq'), comment: content }),
                    success: function(res) { if (res.message === 'SUCCESS') { $('#commentInput').val(''); loadComments(); } else { alert(res.data?.msg || "댓글 등록 실패"); } },
                    error: function() { alert("댓글 등록 중 오류가 발생했습니다."); }
                });
            });

            $(document).on('click', '.delete-comment', function() {
                const commentId = $(this).data('id');
                if (!confirm("댓글을 삭제하시겠습니까?")) return;
                $.ajax({
                    url: '/comment/delete', type: 'POST',
                    data: { commentId: commentId },
                    success: function(res) {
                        if (res.message === 'SUCCESS') { loadComments(); }
                        else { alert(res.data?.msg || "댓글 삭제 실패"); }
                    },
                    error: function() { alert("댓글 삭제 중 오류가 발생했습니다."); }
                });
            });

            $(document).on('click', '.edit-comment', function() {
                const $commentDiv = $(this).closest('.comment');
                const commentId = $commentDiv.data('id');
                const currentText = $commentDiv.find('.comment-text').text();
                if ($commentDiv.find('.edit-textarea').length > 0) return;
                const editFormHtml = `
                    <textarea class="edit-textarea" style="width:100%; height:80px; margin-top: 5px;">${currentText}</textarea>
                    <div>
                        <button class="btn btn-sm btn-primary save-comment" data-id="${commentId}">저장</button>
                        <button class="btn btn-sm btn-light cancel-edit" data-id="${commentId}">취소</button>
                    </div>
                `;
                $commentDiv.find('.comment-text, .delete-comment, .edit-comment').hide();
                $commentDiv.append(editFormHtml);
            });

            $(document).on('click', '.save-comment', function() {
                const commentId = $(this).data('id');
                const $commentDiv = $(this).closest('.comment');
                const updatedText = $commentDiv.find('.edit-textarea').val().trim();
                if (!updatedText) { alert("댓글 내용을 입력하세요."); return; }
                $.ajax({
                    url: '/comment/update', type: 'POST', contentType: 'application/json',
                    data: JSON.stringify({ commentId: commentId, comment: updatedText }),
                    success: function(res) { if (res.message === 'SUCCESS') { loadComments(); } else { alert(res.data?.msg || "댓글 수정 실패"); } },
                    error: function() { alert("댓글 수정 중 오류가 발생했습니다."); }
                });
            });

            $(document).on('click', '.cancel-edit', function() {
                const $commentDiv = $(this).closest('.comment');
                $commentDiv.find('.edit-textarea, .save-comment, .cancel-edit').parent().remove();
                $commentDiv.find('.edit-textarea, .save-comment, .cancel-edit').remove();
                $commentDiv.find('.comment-text, .delete-comment, .edit-comment').show();
            });
        });
    </script>
</head>
<body>

<div class="container">
    <div class="card shadow-sm my-5 custom-card">
        <div class="card-body p-4 p-md-5">
            <h1>문의 상세보기</h1>
            <table class="notice-table">
                <tbody>
                <tr>
                    <th>제목</th>
                    <td id="title"></td>
                </tr>
                <tr>
                    <th>작성자</th>
                    <td id="userId"></td>
                </tr>
                <tr>
                    <th>작성일</th>
                    <td id="regDt"></td>
                </tr>
                <tr id="chgDtRow" style="display: none;">
                    <th>수정일</th>
                    <td id="chgDt"></td>
                </tr>
                <tr>
                    <th>내용</th>
                    <td id="contents"></td>
                </tr>
                <tr id="imageRow">
                    <th>이미지</th>
                    <td id="imageContainer"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="button-group">
            <span>
                <button id="btnEdit" class="btn btn-primary form-button" style="display:none;">수정</button>
                <button id="btnDelete" class="btn btn-danger form-button" style="display:none;">삭제</button>
            </span>
            <button id="btnList" class="btn btn-secondary form-button">목록</button>
        </div>

        <section id="commentSection">
            <h3>댓글</h3>
            <textarea id="commentInput" rows="3" placeholder="댓글을 입력하세요." class="form-control" style="margin-bottom:10px;"></textarea>
            <button id="btnAddComment" class="btn btn-primary">댓글 등록</button>
            <div id="commentList" style="margin-top: 20px;"></div>
        </section>
    </div>
</div>

<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

</body>
</html>