<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>공지사항 상세보기</title>

    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
    <link href="/css/sb-admin-2.min.css" rel="stylesheet">

    <style>
        body { background-color: #b2ebf2; }
        .custom-card { max-width: 800px; margin: 40px auto; background-color: white; border-radius: 0.35rem; border: 1px solid #e3e6f0; }
        h1 { font-size: 1.5rem; font-weight: 700; margin-top: 1rem; margin-bottom: 1.5rem; text-align: center; color: #3a3b45; }
        .notice-table { width: 100%; border-top: 2px solid #3a3b45; }
        .notice-table tr { border-bottom: 1px solid #e3e6f0; }
        .notice-table th, .notice-table td { padding: 1rem; vertical-align: middle; }
        .notice-table th { width: 100px; font-weight: 700; color: #5a5c69; background-color: #f8f9fc; text-align: center; }
        .notice-table td { line-height: 1.6; }
        .notice-table tr:has(td#contents) th { vertical-align: top; padding-top: 1.1rem; }
        #contents { min-height: 200px; white-space: pre-wrap; }
        .button-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 2rem; padding: 0 1rem 1rem; }
        .form-button { font-weight: 600; }
        .like-section { text-align: right; margin: 1rem; }
    </style>

    <script src="/js/jquery-3.6.0.min.js"></script>
    <script>
        let noticeData = null;
        let liked = false;

        function getParameterByName(name) {
            const url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        function loadNoticeInfo() {
            const nSeq = getParameterByName('nSeq');
            if (!nSeq) {
                alert("잘못된 접근입니다.");
                location.href = "/main/notice/noticeList";
                return;
            }

            $.ajax({
                url: '/notice/noticeInfo',
                type: 'GET',
                data: { nSeq: nSeq },
                success: function(response) {
                    if (response.message === 'SUCCESS') {
                        noticeData = response.data.notice;
                        const adminYn = response.data.adminYn; // ★★★ 핵심 수정: sessionStorage 대신 API 응답에서 adminYn 값을 가져옵니다.

                        $('#title').text(noticeData.title);
                        $('#regDt').text(noticeData.regDt);
                        $('#readCnt').text(noticeData.readCnt);
                        $('#contents').html(noticeData.contents.replace(/\n/g, '<br/>'));

                        if (noticeData.chgDt) {
                            $('#chgDt').text(noticeData.chgDt);
                            $('#chgDtRow').show();
                        }

                        // 가져온 adminYn 값을 사용하여 버튼 표시 여부 결정
                        if (adminYn === 'Y') {
                            $('#btnEdit, #btnDelete').show();
                        } else {
                            $('#btnEdit, #btnDelete').hide();
                        }

                        loadLikeStatus(); // 좋아요 상태 및 수 불러오기
                    } else {
                        alert("공지사항을 불러오는 데 실패했습니다.");
                    }
                },
                error: function() { alert("에러가 발생했습니다."); }
            });
        }

        function loadLikeStatus() {
            if (!noticeData) return;

            $.ajax({
                url: "/notice/likeCount",
                type: "GET",
                data: { nSeq: noticeData.noticeSeq },
                success: function(res) {
                    if (res.message === "SUCCESS") {
                        $("#likeCount").text(res.data.count);
                        liked = res.data.liked;
                        updateLikeButton();
                    }
                }
            });
        }

        function updateLikeButton() {
            if (liked) {
                $("#btnLike").addClass("btn-info").removeClass("btn-outline-info");
            } else {
                $("#btnLike").addClass("btn-outline-info").removeClass("btn-info");
            }
        }

        $(document).ready(function() {
            loadNoticeInfo();

            $('#btnEdit').on('click', function() {
                if(noticeData) location.href = "/main/notice/noticeEditInfo?nSeq=" + noticeData.noticeSeq;
            });

            $('#btnDelete').on('click', function() {
                if (noticeData && confirm("작성한 글을 삭제하시겠습니까?")) {
                    $.ajax({
                        url: "/notice/noticeDelete",
                        type: "POST",
                        dataType: "json",
                        data: { nSeq: noticeData.noticeSeq },
                        success: function(json) {
                            alert(json.data.msg);
                            location.href = "/main/notice/noticeList";
                        },
                        error: function() { alert("삭제 중 에러가 발생했습니다."); }
                    });
                }
            });

            $('#btnList').on('click', function() {
                location.href = "/main/notice/noticeList";
            });

            $('#btnLike').on('click', function() {
                if (!noticeData) return;

                const url = liked ? "/notice/noticeCancelLike" : "/notice/noticeLike";

                $.ajax({
                    url: url,
                    type: "POST",
                    data: { nSeq: noticeData.noticeSeq },
                    success: function(res) {
                        if (res.message === "SUCCESS") {
                            $("#likeCount").text(res.data.count); // 즉시 업데이트
                            liked = res.data.liked;              // 상태 업데이트
                            updateLikeButton();                  // 버튼 색상 반영
                        } else {
                            alert(res.data?.msg || "좋아요 처리 실패");
                        }
                    },
                    error: function() { alert("좋아요 처리 중 오류 발생"); }
                });
            });
        });
    </script>
</head>
<body>
<div class="container">
    <div class="card shadow-sm my-5 custom-card">
        <div class="card-body p-4 p-md-5">
            <h1>공지사항 상세보기</h1>
            <table class="notice-table">
                <tbody>
                <tr><th>제목</th><td id="title"></td></tr>
                <tr><th>작성일</th><td id="regDt"></td></tr>
                <tr id="chgDtRow" style="display: none;"><th>수정일</th><td id="chgDt"></td></tr>
                <tr><th>조회수</th><td id="readCnt"></td></tr>
                <tr><th>내용</th><td id="contents"></td></tr>
                </tbody>
            </table>

            <div class="like-section">
                <button id="btnLike" class="btn btn-outline-info">
                    <i class="fas fa-thumbs-up"></i> 좋아요 <span id="likeCount">0</span>
                </button>
            </div>
        </div>

        <div class="button-group">
            <button id="btnEdit" class="btn btn-primary form-button" style="display:none;">수정</button>
            <button id="btnDelete" class="btn btn-danger form-button" style="display:none;">삭제</button>
            <button id="btnList" class="btn btn-secondary form-button">목록</button>
        </div>
    </div>
</div>

<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
</body>
</html>