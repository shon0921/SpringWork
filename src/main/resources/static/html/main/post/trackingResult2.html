<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ë°°ì†¡ ì¡°íšŒ ê²°ê³¼</title>

    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
    <link href="/css/sb-admin-2.min.css" rel="stylesheet">

    <style>
        body { -webkit-text-size-adjust: 100%; }
        .custom-card { max-width: 500px; height: auto; margin: auto; }
        .card-title { font-size: 1.5rem; text-align: center; font-weight: 700; margin-bottom: 20px; }
        #summary p { font-size: 0.95rem; margin-bottom: 0.5rem; }
        .table { width: 100%; margin-top: 15px; font-size: 0.9rem; }
        .table th, .table td { padding: 12px 8px; vertical-align: middle; text-align: center; white-space: nowrap; }
        .table td:last-child { text-align: left; white-space: normal; word-break: keep-all; }
        #backButton { position: absolute; top: 20px; left: 20px; z-index: 10; background: none; border: none; padding: 0; cursor: pointer; font-size: 1.5rem; color: #858796; }
        #backButton:hover { color: #5a5c69; }
        #map { width: 100%; height: 300px; margin-top: 20px; border: 1px solid #e3e6f0; }
        .map-loading { display: flex; justify-content: center; align-items: center; height: 100%; color: #888; }
        .infowindow-content { padding: 8px 12px; font-size: 13px; text-align: center; border: 1px solid #ccc; background: white; border-radius: 4px; font-weight: 600; }
        @media (max-width: 576px) {
            .card-title { font-size: 1.3rem; }
            #summary p { font-size: 0.9rem; }
            .table { font-size: 0.8rem; }
            .table th, .table td { padding: 10px 5px; }
            #map { height: 250px; }
        }
    </style>
</head>
<body class="bg-gradient-primary">

<div class="container">
    <div class="card o-hidden border-0 shadow-lg my-5 custom-card">
        <button type="button" id="backButton">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="card-body p-4">
            <h1 class="card-title text-center mb-4">ë°°ì†¡ ì¡°íšŒ ê²°ê³¼</h1>
            <div id="summary">
                <p><strong>íƒë°°ì‚¬:</strong> <span id="carrierName"></span></p>
                <p><strong>ì†¡ì¥ë²ˆí˜¸:</strong> <span id="trackingNumberDisplay"></span></p>
                <p><strong>ë³´ë‚¸ ì‚¬ëŒ:</strong> <span id="fromName"></span></p>
                <p><strong>ë°›ëŠ” ì‚¬ëŒ:</strong> <span id="toName"></span></p>
                <p><strong>ë°°ì†¡ ìƒíƒœ:</strong> <span id="stateText"></span></p>
            </div>
            <div class="table-responsive">
                <table id="trackingTable" class="table table-bordered">
                    <thead><tr><th>ì‹œê°„</th><th>ìƒíƒœ</th><th>ìœ„ì¹˜</th><th>ì„¤ëª…</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="map"><div class="map-loading">ì§€ë„ ë¡œë”© ì¤‘...</div></div>
            <div class="text-center">
                <button id="saveOrDeleteBtn" class="btn btn-primary mt-4" disabled>ë¡œë”© ì¤‘...</button>
            </div>
        </div>
    </div>
</div>

<script src="/js/jquery-3.6.0.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=81fdc7b327d29dbcddbf72af3b99d04f&libraries=services"></script>
<script src="/js/sb-admin-2.min.js"></script>

<script>
    // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
    const carrierMap = { 'kr.cjlogistics': 'CJëŒ€í•œí†µìš´', 'kr.epost': 'ìš°ì²´êµ­íƒë°°', 'kr.hanjin': 'í•œì§„íƒë°°', 'kr.lotte': 'ë¡¯ë°íƒë°°' };
    let latestTrackingData = null;      // APIë¡œë¶€í„° ë°›ì€ ìˆœìˆ˜ ë°°ì†¡ ì •ë³´ (TrackingDTO)
    let requestToAddress = '';          // ì¡°íšŒ ì‹œ ì‚¬ìš©í–ˆë˜ 'ë„ì°© ì£¼ì†Œ'
    let requestTrackingNumber = '';     // ì¡°íšŒ ì‹œ ì‚¬ìš©í–ˆë˜ 'ì†¡ì¥ ë²ˆí˜¸'
    let isSaved = false;                // DBì— ì €ì¥ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
    let refinedStartInfo = { address: '', lat: null, lng: null }; // ì§€ë„ ê²½ë¡œ ê·¸ë¦¬ê¸°ë¥¼ ìœ„í•œ ì¶œë°œì§€ ì •ë³´

    // --- í—¬í¼ í•¨ìˆ˜ ---
    function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    /**
     * [ìˆ˜ì •] ì„œë²„ì˜ ì£¼ì†Œ ì •ì œ APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
     * @param {string} ambiguousTerm - ì •ì œí•  ëª¨í˜¸í•œ ì£¼ì†Œ ë¬¸ìì—´
     * @returns {Promise<string>} ì •ì œëœ ì£¼ì†Œ ë¬¸ìì—´
     */
    async function getRefinedSearchTerm(ambiguousTerm) {
        console.log(`[1ë‹¨ê³„: ì„œë²„ í˜¸ì¶œ] ëª¨í˜¸í•œ ê²€ìƒ‰ì–´ '${ambiguousTerm}' ì •ì œë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.`);
        try {
            // ì„œë²„ì˜ '/tracking/get-refined-address' ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ìš”ì²­
            const response = await fetch('/tracking/get-refined-address', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ambiguousTerm: ambiguousTerm }) // ìš”ì²­ ë³¸ë¬¸ì— ë°ì´í„° ì „ì†¡
            });

            if (!response.ok) {
                // ì„œë²„ ì‘ë‹µì´ ì‹¤íŒ¨ì¸ ê²½ìš° (4xx, 5xx ë“±)
                throw new Error(`ì£¼ì†Œ ì •ì œ API ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
            }

            const data = await response.json(); // ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±

            if (data.error) {
                // ì„œë²„ì—ì„œ 'error' í•„ë“œë¥¼ í¬í•¨í•˜ì—¬ ì‘ë‹µí•œ ê²½ìš°
                throw new Error(data.error);
            }

            const refinedTerm = data.refinedAddress; // 'refinedAddress' í‚¤ì˜ ê°’ì„ ê°€ì ¸ì˜´
            console.log(`[2ë‹¨ê³„: ì„œë²„ ì‘ë‹µ] ì„±ê³µì ìœ¼ë¡œ ë³€í™˜í–ˆìŠµë‹ˆë‹¤. ğŸ‘‰ '${refinedTerm}'`);
            return refinedTerm;

        } catch (error) {
            console.error("[ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨]", error);
            // API í˜¸ì¶œì— ì‹¤íŒ¨í•˜ë©´ ì›ë˜ì˜ ê²€ìƒ‰ì–´ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ì—¬ ë‹¤ìŒ ë¡œì§ì´ ë™ì‘í•˜ë„ë¡ í•¨
            return ambiguousTerm;
        }
    }


    async function getDirection(start, end, map) {
        const KAKAO_REST_API_KEY = "e6363c30237aa9b08e811ac1c81fb9b4";
        try {
            const response = await fetch(`https://apis-navi.kakaomobility.com/v1/directions?origin=${start.getLng()},${start.getLat()}&destination=${end.getLng()},${end.getLat()}`, {
                headers: { 'Authorization': `KakaoAK ${KAKAO_REST_API_KEY}`, 'Content-Type': 'application/json' }
            });
            if (!response.ok) throw new Error(`ê²½ë¡œ API ì˜¤ë¥˜: ${response.status}`);
            const data = await response.json();
            if (data.routes && data.routes.length > 0) {
                const linePath = data.routes[0].sections.flatMap(section =>
                    section.roads.flatMap(road => {
                        const path = [];
                        for (let i = 0; i < road.vertexes.length; i += 2) {
                            path.push(new kakao.maps.LatLng(road.vertexes[i + 1], road.vertexes[i]));
                        }
                        return path;
                    })
                );
                new kakao.maps.Polyline({
                    path: linePath, strokeWeight: 5, strokeColor: '#007bff', strokeOpacity: 0.8, strokeStyle: 'solid'
                }).setMap(map);
            }
        } catch (e) {
            console.error("ê²½ë¡œ API ì˜¤ë¥˜:", e);
        }
    }

    function showSimpleInfoWindow(map, marker, text) {
        const content = `<div style="padding: 8px 12px; font-size: 13px; text-align: center; border: 1px solid #ccc; background: white; border-radius: 4px; font-weight: 600;">${text}</div>`;
        const infowindow = new kakao.maps.InfoWindow({ content: content, removable: true });
        infowindow.open(map, marker);
    }

    async function drawRouteWithGemini(startAddr, endAddr, map, geocoder, ps) {
        // [ìˆ˜ì •] í•¨ìˆ˜ ì´ë¦„ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ë§Œ, ë‚´ë¶€ì ìœ¼ë¡œëŠ” ìš°ë¦¬ ì„œë²„ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
        const refinedAddr = await getRefinedSearchTerm(startAddr);
        console.log(`[3ë‹¨ê³„: ì¹´ì¹´ì˜¤ë§µ í˜¸ì¶œ] ì •ì œëœ ê²€ìƒ‰ì–´ '${refinedAddr}'ë¡œ ì¥ì†Œ ê²€ìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤.`);
        refinedStartInfo.address = refinedAddr;
        ps.keywordSearch(refinedAddr, (places, status) => {
            if (status === kakao.maps.services.Status.OK && places.length > 0) {
                const foundPlace = places[0];
                const startCoords = new kakao.maps.LatLng(foundPlace.y, foundPlace.x);
                refinedStartInfo.lat = foundPlace.y;
                refinedStartInfo.lng = foundPlace.x;
                const marker = new kakao.maps.Marker({ map, position: startCoords });
                showSimpleInfoWindow(map, marker, "ì¶œë°œì§€");
                searchEndAndDrawRoute(startCoords, endAddr, map, geocoder);
            } else {
                console.error(`ì¶œë°œì§€ ìœ„ì¹˜ '${refinedAddr}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                searchEndAndDrawRoute(null, endAddr, map, geocoder);
            }
        });
    }

    function searchEndAndDrawRoute(startCoords, endAddr, map, geocoder) {
        geocoder.addressSearch(endAddr, (endResult, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const endCoords = new kakao.maps.LatLng(endResult[0].y, endResult[0].x);
                const marker = new kakao.maps.Marker({ map, position: endCoords });
                showSimpleInfoWindow(map, marker, "ë„ì°©ì§€");
                if (startCoords) {
                    const bounds = new kakao.maps.LatLngBounds();
                    bounds.extend(startCoords);
                    bounds.extend(endCoords);
                    map.setBounds(bounds);
                    getDirection(startCoords, endCoords, map);
                } else {
                    map.setCenter(endCoords);
                }
            } else {
                $("#map").html('<div class="map-loading">ë„ì°©ì§€ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>');
            }
        });
    }

    // DTO êµ¬ì¡°ì— ë§ê²Œ í™”ë©´ì˜ ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderTrackingData(dto) {
        $("#carrierName").text(dto.carrier?.name || 'ì •ë³´ ì—†ìŒ');
        $("#fromName").text(dto.from?.name || 'ì •ë³´ ì—†ìŒ');
        $("#toName").text(dto.to?.name || 'ì •ë³´ ì—†ìŒ');
        $("#stateText").text(dto.state?.text || 'ì •ë³´ ì—†ìŒ');
        const progresses = dto.progresses || [];
        const displayProgresses = progresses.filter(item => item.status?.text !== 'ì¸ìˆ˜ìë“±ë¡');
        const tbody = $("#trackingTable tbody").empty();
        if (displayProgresses.length > 0) {
            displayProgresses.forEach(item => {
                const row = `<tr><td>${formatDateTime(item.time)}</td><td>${item.status?.text || 'ìƒíƒœ ì—†ìŒ'}</td><td>${item.location?.name || 'ìœ„ì¹˜ ì—†ìŒ'}</td><td>${item.description || ''}</td></tr>`;
                tbody.append(row);
            });
        } else {
            tbody.append('<tr><td colspan="4">ë°°ì†¡ ì§„í–‰ í˜„í™©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
        }
    }

    // DBì— ì €ì¥ëœ ê¸°ë¡ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    async function checkIfSaved() {
        if (!requestToAddress || !requestTrackingNumber) return;
        try {
            isSaved = await $.get("/post/checkLogExist", {
                toAddress: requestToAddress,
                trackingNumber: requestTrackingNumber
            });
            console.log(`ì €ì¥ ì—¬ë¶€ í™•ì¸ ê²°ê³¼: ${isSaved}`);
        } catch (e) {
            console.error("ì €ì¥ ì—¬ë¶€ í™•ì¸ ì‹¤íŒ¨", e);
            isSaved = false;
        }
    }

    // ì €ì¥/ì‚­ì œ ë²„íŠ¼ì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateButton() {
        const $btn = $("#saveOrDeleteBtn");
        if (!latestTrackingData) return;
        $btn.prop("disabled", false);
        if (isSaved) {
            $btn.text("ë°°ì†¡ì¡°íšŒ ê²°ê³¼ ì‚­ì œ").removeClass("btn-primary").addClass("btn-danger");
        } else {
            $btn.text("ë°°ì†¡ì¡°íšŒ ê²°ê³¼ ì €ì¥").removeClass("btn-danger").addClass("btn-primary");
        }
    }

    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ ë¡œì§
    $(document).ready(async function() {
        const returnUrl = sessionStorage.getItem('returnUrl');

        const fallbackUrl = "/main/post/deliverytracking";
        $("#backButton").on("click", function () {
            location.href = returnUrl || fallbackUrl;
        });

        const liveTrackingDataStr = sessionStorage.getItem('latestTrackingData');
        console.log("ê²°ê³¼ í˜ì´ì§€ ë¡œë“œë¨. sessionStorage ë°ì´í„° í™•ì¸:", liveTrackingDataStr);

        const mapContainer = document.getElementById('map');
        const map = new kakao.maps.Map(mapContainer, { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 7 });
        const geocoder = new kakao.maps.services.Geocoder();
        const ps = new kakao.maps.services.Places();

        try {
            if (liveTrackingDataStr) {
                const dataFromStorage = JSON.parse(liveTrackingDataStr);

                latestTrackingData = dataFromStorage.trackingInfo;
                requestToAddress = dataFromStorage.toAddress;
                requestTrackingNumber = dataFromStorage.trackingNumber;

                console.log("ì¶”ì¶œëœ ë°°ì†¡ì •ë³´ DTO:", latestTrackingData);
                console.log("ì¶”ì¶œëœ ë„ì°©ì£¼ì†Œ:", requestToAddress);
                console.log("ì¶”ì¶œëœ ì†¡ì¥ë²ˆí˜¸:", requestTrackingNumber);

                $("#trackingNumberDisplay").text(requestTrackingNumber || 'ì •ë³´ ì—†ìŒ');
                renderTrackingData(latestTrackingData);

                await checkIfSaved();

                if (latestTrackingData.progresses && latestTrackingData.progresses.length > 0) {
                    let startLocationName = '';
                    for (let i = latestTrackingData.progresses.length - 1; i >= 0; i--) {
                        const locationName = latestTrackingData.progresses[i].location?.name;
                        if (locationName && locationName !== 'ê³ ê°') {
                            startLocationName = locationName;
                            break;
                        }
                    }
                    if (startLocationName) {
                        const carrierName = carrierMap[latestTrackingData.carrier.id] || '';
                        const searchTerm = `${startLocationName} ${carrierName}`;
                        await drawRouteWithGemini(searchTerm, requestToAddress, map, geocoder, ps);
                    } else {
                        $("#map").html('<div class="map-loading">ìœ íš¨í•œ ì¶œë°œì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>');
                    }
                } else {
                    $("#map").html('<div class="map-loading">ë°°ì†¡ ì‹œì‘ ì „ì´ê±°ë‚˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                }
            } else {
                $("#summary").html("<p class='text-center'>ì¡°íšŒí•  ë°°ì†¡ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>");
                $("#map, #trackingTable, #saveOrDeleteBtn").hide();
            }
        } catch (err) {
            console.error("ê²°ê³¼ í˜ì´ì§€ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
            alert("í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err.message);
            $("#map").html('<div class="map-loading">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>');
        } finally {
            updateButton();
            sessionStorage.removeItem('latestTrackingData');
            sessionStorage.removeItem('returnUrl');
            console.log("ì„ì‹œ sessionStorage ë°ì´í„°ë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.");
        }
    });

    // ì €ì¥/ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $("#saveOrDeleteBtn").on("click", function () {
        if (!latestTrackingData) return alert("ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        const $btn = $(this);
        $btn.prop('disabled', true);

        if (isSaved) {
            $.ajax({
                type: "DELETE", url: "/post/deleteLog", contentType: "application/json",
                data: JSON.stringify({
                    toAddress: requestToAddress,
                    trackingNumber: requestTrackingNumber
                })
            }).done(res => {
                if (res.message === "SUCCESS") {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    isSaved = false;
                    updateButton();
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + (res.message || ''));
                }
            }).fail(() => alert("ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"))
                .always(() => $btn.prop('disabled', false));
        } else {
            let lastTime = null;
            const displayProgresses = (latestTrackingData.progresses || []).filter(p => p.status?.text !== 'ì¸ìˆ˜ìë“±ë¡');
            if (displayProgresses.length > 0) {
                lastTime = displayProgresses[displayProgresses.length - 1].time;
            }

            let notifSentOutForDelivery = false;
            let notifSentDelivered = false;
            const currentStateId = latestTrackingData.state?.id;

            if (currentStateId === 'out_for_delivery' || currentStateId === 'delivered') { notifSentOutForDelivery = true; }
            if (currentStateId === 'delivered') { notifSentDelivered = true; }

            const saveDto = {
                carrierId: latestTrackingData.carrier.id,
                carrierName: latestTrackingData.carrier.name,
                fromName: latestTrackingData.from.name,
                toName: latestTrackingData.to.name,
                stateId: latestTrackingData.state.id,
                stateText: latestTrackingData.state.text,
                toAddress: requestToAddress,
                trackingNumber: requestTrackingNumber,
                lastDeliveryTime: lastTime,
                startAddress: refinedStartInfo.address,
                startLat: refinedStartInfo.lat,
                startLng: refinedStartInfo.lng,
                notificationSentForOutForDelivery: notifSentOutForDelivery,
                notificationSentForDelivered: notifSentDelivered
            };

            $.ajax({
                type: "POST", url: "/post/saveLog", contentType: "application/json",
                data: JSON.stringify(saveDto)
            }).done(res => {
                if (res.message === "SUCCESS") {
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    isSaved = true;
                    updateButton();
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + (res.message || ''));
                }
            }).fail(() => alert("ì €ì¥ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"))
                .always(() => $btn.prop('disabled', false));
        }
    });
</script>

</body>
</html>