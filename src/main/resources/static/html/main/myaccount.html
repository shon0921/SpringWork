<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <title>내 정보</title>

  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet" />

  <link href="/css/sb-admin-2.min.css" rel="stylesheet" />

  <style>
    .custom-card {
      max-width: 500px;
      height: 640px;
      margin: auto;
      background-color: white;
      border-radius: 12px;
      padding: 40px 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .user {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 30px;
      color: #000;
    }

    .info-text {
      width: 100%;
      background-color: #f8f9fc;
      padding: 15px;
      margin: 10px 0;
      font-size: clamp(1rem, 2.5vw, 1.2rem);
      font-weight: 500;
      color: #000;
      text-align: center;
      border-radius: 8px;
    }

    .menu-button {
      font-size: clamp(1rem, 2vw, 1.3rem);
      height: clamp(45px, 5vw, 65px);
      width: 100%;
      max-width: 500px;
      margin: 10px 0;
      border-radius: 12px;
      font-weight: 500;
      background-color: #e0e0e0;
      color: #000;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .menu-button:hover {
      background-color: #d0d0d0;
    }

    .menu-button.red {
      background-color: #e57373;
      color: white;
    }

    .menu-button.red:hover {
      background-color: #d32f2f;
    }

    #backButton {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      font-size: 1.5rem;
      color: #858796;
    }

    #backButton:hover {
      color: #5a5c69;
    }
  </style>

  <script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {

      let userInfo;

      // --- 1. 페이지 로딩 시, API를 호출하여 사용자 정보 가져오기 ---
      $.ajax({
        url: "/user/info",
        type: "get",
        dataType: "JSON",
        contentType: "application/json",
        success: function (json) {
          if (json.data) {
            userInfo = json.data;

            // 아이디와 가입일을 각각의 div에 텍스트로 넣어줌
            $("#userIdText").text("아이디: " + userInfo.userId);
            $("#regDtText").text("가입일: " + userInfo.regDt);
          }
        },
        error: function (xhr) {
          if (xhr.status === 401) {
            alert("로그인이 필요합니다.");
            location.href = "/html/login.html";
          } else {
            alert("정보를 불러오는데 실패했습니다: " + xhr.responseJSON.message);
          }
        }
      });

      // --- 2. 기존 버튼 이벤트 핸들러들 ---
      $("#backButton").on("click", function () {
        location.href = "/main/title";
      });

      // --- 이제 userInfo 변수에 정상적으로 접근할 수 있습니다 ---
      $("#changepassword").on("click", function () {
        // userInfo 변수가 할당될 때까지 잠시 기다려줍니다. (안전장치)
        if (!userInfo) {
          alert("사용자 정보를 불러오는 중입니다. 잠시 후 다시 시도해주세요.");
          return;
        }

        if (userInfo.provider === "naver") {
          alert("소셜 로그인 사용자는 비밀번호를 변경할 수 없습니다.");
        } else {
          location.href = "/main/changepassword";
        }
      });

      $("#inquiry").on("click", function () {
        location.href = "/main/inquiry/inquiryList";
      });

      // '회원탈퇴' 버튼 클릭 이벤트 수정
      $("#delete").on("click", function () {
        if (!userInfo) {
          alert("사용자 정보를 불러오는 중입니다. 잠시 후 다시 시도해주세요.");
          return;
        }

        // --- 🚨 여기가 핵심입니다 ---
        // 1. 네이버 회원인 경우
        if (userInfo.provider === "naver") {
          if (confirm("비밀번호 확인 없이 즉시 탈퇴 처리됩니다.\n정말 탈퇴하시겠습니까?")) {
            // "예"를 누르면, 비밀번호 없이 바로 탈퇴시키는 API를 호출합니다.
            $.ajax({
              url: "/user/delete-social", // 소셜 전용 탈퇴 API
              type: "post",
              dataType: "JSON",
              success: function (json) {
                alert(json.msg);
                if (json.result === 1) {
                  sessionStorage.clear();
                  location.href = "/";
                }
              },
              error: function() {
                alert("회원탈퇴 처리 중 오류가 발생했습니다.");
              }
            });
          }
        } else {
          // 2. 일반 회원인 경우
          // 기존처럼 비밀번호를 입력하는 페이지로 이동합니다.
          location.href = "/main/accountdelete";
        }
      });

      $("#logout").on("click", function () {
        if (confirm("로그아웃 하시겠습니까?")) {
          $.ajax({
            url: "/user/logout",
            type: "POST",
            dataType: "json",
            success: function (json) {
              alert(json.msg);
              if (json.result === 1) {
                sessionStorage.clear();
                location.href = "/";
              }
            },
            error: function() {
              alert("로그아웃 처리 중 오류가 발생했습니다.");
            }
          });
        }
      });
    });
  </script>
</head>

<body class="bg-gradient-primary">
<div class="container">
  <div class="card o-hidden border-0 shadow-lg my-5 custom-card">
    <button type="button" id="backButton">
      <i class="fas fa-chevron-left"></i>
    </button>
    <div class="user">
      <h1>내정보</h1>

      <div id="userIdText" class="info-text"></div>
      <div id="regDtText" class="info-text"></div>

      <button id="changepassword" type="button" class="menu-button">비밀번호 변경</button>
      <button id="inquiry" type="button" class="menu-button">문의하기</button>
      <button id="logout" type="button" class="menu-button">로그아웃</button>
      <button id="delete" type="button" class="menu-button red">회원탈퇴</button>
    </div>
  </div>
</div>

<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/vendor/fontawesome-free/js/all.min.js"></script>
</body>

</html>