<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>비회원 배송조회</title>

    <!-- CSS Imports -->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="/css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        #backButton {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 1.5rem;
            color: #858796;
        }

        #backButton:hover {
            color: #5a5c69;
        }

        .custom-card {
            width: 100%;
            max-width: 500px;
            height: 640px;
            margin: auto;
            position: relative;
            padding-top: 20px;
            box-sizing: border-box;
        }

        .custom-card .p-5 {
            padding: 2rem !important;
        }

        .user button {
            margin-top: 50px;
            padding: 14px 0;
            font-size: 1.2rem;
            height: 60px;
        }

        .user button:first-of-type {
            margin-top: 30px;
        }

        .user button:last-of-type {
            margin-top: 30px;
        }
    </style>

    <!-- jQuery -->
    <script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>

    <!-- ==================== JavaScript (수정된 핵심 로직) ==================== -->
    <script type="text/javascript">
        $(document).ready(function () {
            // '뒤로 가기' 버튼 클릭 이벤트
            $("#backButton").on("click", function () {
                location.href = "/"; // 원하는 이전 페이지로 설정
            });

            // '배송조회' 버튼 클릭 이벤트
            $("#Guestdeliverytracking").on("click", function () {
                let carrierId = $("#carrierId").val();
                let trackingNumber = $("#trackingnumber").val().trim(); // 공백 제거

                // 1. 입력값 검증 (Validation)
                if (carrierId === "") {
                    alert("택배사를 선택하세요.");
                    $("#carrierId").focus();
                    return;
                }
                if (trackingNumber === "") {
                    alert("배송번호를 입력하세요.");
                    $("#trackingnumber").focus();
                    return;
                }

                // 2. AJAX를 통한 서버 요청
                $.ajax({
                    url: "/tracking/search",
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json", // 서버가 JSON을 반환할 것을 명시
                    data: JSON.stringify({ carrierId: carrierId, trackingNumber: trackingNumber })
                })
                    .done(function (response) {
                        // 3-1. 성공 콜백 (HTTP 2xx 응답 시 실행)
                        console.log("서버 응답 (성공):", response);
                        if (response.result === "OK") {
                            alert("조회 성공.");
                            // 성공 시 바로 결과 페이지로 이동 (더 나은 UX)
                            location.href = "/trackingResult";
                        }
                    })
                    .fail(function (jqXHR) {
                        // 3-2. 실패 콜백 (HTTP 4xx, 5xx 등 오류 응답 시 실행)
                        console.error("서버 응답 (실패):", jqXHR);

                        let errorMessage = "조회 중 알 수 없는 오류가 발생했습니다.";

                        // 서버가 보낸 JSON 형식의 오류 메시지가 있는지 확인
                        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                            // 백엔드 컨트롤러에서 보낸 message 값을 사용
                            errorMessage = jqXHR.responseJSON.message;
                        }

                        alert(errorMessage);
                    });
            });
        });
    </script>
    <!-- =================================================================== -->
</head>
<body class="bg-gradient-primary">

<div class="container">
    <div class="card o-hidden border-0 shadow-lg my-5 custom-card">
        <button type="button" id="backButton">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="p-5">
            <div class="text-center">
                <h1 class="h4 text-gray-900 mb-4">비회원 배송조회</h1>
            </div>
            <form class="user" id="f" onsubmit="return false;"> <!-- form의 기본 제출 방지 -->
                <!-- 택배사 선택 드롭다운 -->
                <div class="form-group">
                    <label for="carrierId">택배사 선택</label>
                    <select class="form-control" id="carrierId" style="border-radius: 10rem; padding-left: 1rem; font-size: .8rem; height: 50px;">
                        <option value="">-- 택배사를 선택하세요 --</option>
                        <option value="kr.epost">우체국택배</option>
                        <option value="kr.cjlogistics">CJ대한통운</option>
                        <option value="kr.lotte">롯데택배</option>
                        <!-- 필요에 따라 다른 택배사 추가 -->
                    </select>
                </div>

                <!-- 배송번호 입력 -->
                <div class="form-group">
                    <label for="trackingnumber">배송번호 입력</label>
                    <input type="text" class="form-control form-control-user" name="trackingnumber" id="trackingnumber" placeholder="'-' 없이 숫자만 입력">
                </div>

                <!-- 배송조회 버튼 -->
                <button id="Guestdeliverytracking" class="btn btn-primary btn-user btn-block" type="button">
                    배송조회
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript-->
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/js/sb-admin-2.min.js"></script>

</body>
</html>