<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>휴대폰 인증</title>

  <!-- 외부 리소스 -->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />
  <link href="/css/sb-admin-2.min.css" rel="stylesheet" />
  <script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="/js/jquery.serializeObject.min.js"></script>

  <style>
    .custom-card {
      width: 100%;
      max-width: 460px; /* 기존 500px에서 살짝만 줄임 */
      height: 640px;
      margin: auto;
    }

    .custom-card .p-5 {
      padding: 2.5rem 2rem !important; /* 좌우 여백만 살짝 줄임 */
    }

    .center-input-section {
      height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .form-group {
      margin-bottom: 2rem;
      position: relative; /* 재발송 버튼 절대위치 기준 */
    }

    .resend-btn {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 5px;
      padding: 6px 12px;
      font-size: 0.875rem;
    }

    .submit-btn {
      margin-top: 100px;
      padding: 16px 0;      /* 세로 패딩 살짝 키움 */
      font-size: 1.25rem;   /* 글자 크기 키움 */
      height: 50px;         /* 버튼 높이 살짝 증가 */
    }
  </style>

  <script type="text/javascript">
    $(document).ready(function () {
      $("#btnSend").on("click", function () {
        doSubmit();
      });

      $("#btnReSend").on("click", function () {
        resendAuthCode();
      });
    });

    function resendAuthCode() {
      $.ajax({
        url: "/user/resendAuthCode",
        type: "POST",
        contentType: "application/json",
        dataType: "json",
      }).done(function(response) {
        var result = response.data;
        if (result != null && result.result === 0) {
          sessionStorage.setItem('authNumber', result.newAuthNumber);
          $("#authNumber").val('');
          alert(result.msg);
        } else {
          alert(result != null && result.msg ? result.msg : "인증번호 재발송에 실패했습니다. 다시 시도해주세요.");
        }
      }).fail(function(xhr, status, error) {
        alert("서버 오류로 인증번호 재발송에 실패했습니다.");
        console.error(error);
      });
    }

    function doSubmit() {
      const f = document.getElementById("f");
      const enteredAuthNumber = f.authNumber.value;
      const savedAuthNumber = sessionStorage.getItem('authNumber');

      if (enteredAuthNumber === "") {
        alert("핸드폰 인증번호를 입력하세요.");
        f.authNumber.focus();
        return;
      }

      if (enteredAuthNumber !== savedAuthNumber) {
        alert("핸드폰 인증번호가 일치하지 않습니다.");
        f.authNumber.focus();
        return;
      }

      $.ajax({
        url: "/user/register2",
        type: "post",
        contentType: "application/json",
        dataType: "JSON",
        data: JSON.stringify($("#f").serializeObject())
      }).then(
              function (json) {
                alert(json.data.msg);
                if (json.data.result === 1) {
                  sessionStorage.removeItem('authNumber');
                  location.href = "/";
                } else {

                }
              },
              function (json) {
                const result = json.responseJSON.data;
                let errMsg = "";
                for (const data of result) {
                  errMsg += (data.defaultMessage + "\n");
                }
                alert(errMsg);
              }
      );
    }
  </script>
</head>

<body class="bg-gradient-primary">
<div class="container">
  <div class="card o-hidden border-0 shadow-lg my-5 custom-card">
    <div class="p-5">
      <div class="text-center">
        <h1 class="h4 text-gray-900 mb-4">휴대폰 인증</h1>
      </div>
      <form class="user" name="f" id="f">
        <div class="center-input-section">
          <div class="form-group">
            <label for="authNumber">인증번호 입력</label>
            <input
                    type="text"
                    class="form-control form-control-user"
                    id="authNumber"
                    name="authNumber"
                    placeholder="인증번호를 입력하세요"
            />
            <button
                    type="button"
                    name="btnReSend"
                    id="btnReSend"
                    class="btn btn-secondary resend-btn"
            >
              인증번호 재발송
            </button>
          </div>
        </div>

        <button type="button" class="btn btn-primary btn-user btn-block submit-btn" id="btnSend">
          회원가입
        </button>
      </form>
    </div>
  </div>
</div>

<!-- JS 리소스 -->
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/js/sb-admin-2.min.js"></script>
</body>
</html>